# Queue Fix

Currently, the [queue](/home/brokkoli/GITHUB/linguanodon/src/pages/queue/PageQueue.vue) still partly utilizes an old paradigm which differentiates exercises and tasks.

We want to fix that: Tasks only from here on.

For this to work, we need to ensure the following:


- Our new queue paradigm works as follows:
  - A batch is 20 tasks (or, in special cases, less)
  - We have 0-2 tasks based on a [Resource](src/entities/resources/ResourceData.ts).
  - We will fill up the tasks to 20 with tasks based on [Vocab](src/entities/vocab/vocab/VocabData.ts) (or with as much vocab as we get from proposers)
  - First, we will use proposers like the [current vocab proposer](src/pages/queue/propose-relevant-entities/which-vocab-to-practice/VocabPicker.ts) (see also adjacent files) that propose entities (Resources, Vocab, ...) on which to base the tasks on
  - Second, we will use the picked entities and ask the [task repo](src/entities/tasks/TaskData.ts) for tasks based on these entities
  - This way, we fill up a queue batch
- Currently, we only have infrastructure picking `Vocab`. We will need a proposer structure for resource. An empty file starting this was created [here](src/pages/queue/propose-relevant-entities/which-resource-to-practice/ResourcePickerContract.ts)
    - We want two such proposers:
        - one picking the resource that has the `lastShownAt` furthest in the past
        - one picking any new resource (no `lastShownAt`) (randomly)
    - make sure to filter only resources with languages that the user has in their currently *active* target langs
    - make sure to filter only resources where in `tasks` the following is true: *At least one* of the following `taskTypes` ([definition](/home/brokkoli/GITHUB/linguanodon/src/entities/tasks/TaskData.ts)) is either *not* in the list of is in the list and has `isActive` set to true: `add-vocab-to-resource`, `add-examples-to-resource`, `add-fact-cards-to-resource`
- Side note: I removed `isImmersionContent` from `ResourceData`. Adapt accordingly, especially dexie. We do not need a migration strat, we'll simply throw away old data


1. **Task Priority**: Should resource-based tasks always come first in the batch, or should they be randomly distributed among the 20 tasks?

- get tasks in order. In the end, when the queue batch is completed, simply shuffle it. Use an array shuffle function that you put in shared/

2. **Language Filtering**: Where is the "currently active target langs" information stored? Is this in user preferences/settings?

Check [this page](src/pages/languages/PageLanguages.vue) and trace

3. **Task Generation**: Does the TaskRepo already have methods to generate tasks from ResourceData entities, or do we need to implement this logic?

Most should exist. check the [task repo](src/entities/tasks/TaskRepoContract.ts) carefully.

4. **Resource Task Validation**: When filtering resources for required task types, should we check if the tasks exist in the `tasks` array field of ResourceData, or if they can be generated by the TaskRepo?

if they actually exist, right now. THe queue batch generator should not generate tasks!

5. **Fallback Behavior**: What should happen if no resources are available but vocab is available? Should we fill all 20 slots with vocab-based tasks?

yes, as i said, you are supposed to randomly choose ZERO to TWO resource tasks in the first place. So, some batches are naturally going to have only vocab-based tasks

6. **Error Handling**: How should we handle cases where resource proposers fail? Should we continue with vocab-only batches or show an error?

if its an actual error, log it in console as such. then just return no tasks from resources and continue

7. **Performance**: The current system preloads batches in background. Should we maintain the same preloading strategy for the unified task system?

yes, keep preloading